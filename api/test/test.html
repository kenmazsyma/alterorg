<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AlterorgTest</title>
<style>
.lst {
	margin:12px;
	border-collapse:collapse;
	width:90%;
}
.lst th {
	border:1px solid #888;
	padding:2px;
	border-collapse:collapse;
	background-color:#88f;
}
.lst td {
	border:1px solid #888;
	padding:2px;
	border-collapse:collapse;
}

</style>
<script type="text/javascript" src="jquery-2.1.4.min.js"></script>
<script type="text/javascript">
<!--
var orglst = [];
var txlst = {};
var id = 1;
function create() {
	var data = {
		'jsonrpc':'2.0',
		'id':id++,
		'method':'Assembly.Create',
		'params':[{
			'proposal':  'QmUkyqBEkCyqQ9sUAqanaKQ7HKUVfSiUFn6FyenmwwKNXr', 
			'discussion':'AmFkyqBEkCyqQ9sUAqanaKQ7HKUVfSiUFn6FyenmwwKNXr'
		}]
	};
	$.ajax({
		type: "POST",
		url: "http://localhost:1234",
		data: JSON.stringify(data),
		dataType: 'json',
		contentType: "application/json",
		success: function(res){
			txlst[res.result]=[];
			orglst.push(res.result);
			drawState();
		},
		error : function(req, stat,err) {
			$('#log').html(err.message);
		}
	});
}

function getProposal(param) {
	var data = {
		'jsonrpc':'2.0',
		'id':id++,
		'method':'Assembly.GetProposal',
		'params':[param]
	};
	$.ajax({
		type: "POST",
		url: "http://localhost:1234",
		data: JSON.stringify(data),
		dataType: 'json',
		contentType: "application/json",
		success: function(res){
			alert(res.result);
		},
		error : function(req, stat,err) {
			$('#log').html(err.message);
		}
	});
}

function revisionProposal(param, idx) {
	var data = {
		'jsonrpc':'2.0',
		'id':id++,
		'method':'Assembly.RevisionProposal',
		'params':[
		{
			'address': param,
			'proposal':  'QmUkyqBEkCyqQ9sUAqanaKQ7HKUVfSiUFn6FyenmwwKNXr', 
			'discussion':'AmFkyqBEkCyqQ9sUAqanaKQ7HKUVfSiUFn6FyenmwwKNXr'
		}]
	};
	$.ajax({
		type: "POST",
		url: "http://localhost:1234",
		data: JSON.stringify(data),
		dataType: 'json',
		contentType: "application/json",
		success: function(res){
			txlst[idx].push(res.result);
			drawState();
		},
		error : function(req, stat,err) {
			$('#log').html(err.message);
		}
	});
}

function drawState() {
	var html = ['<table class="lst"><th>TX</th><th>ADDRESS</th>'];
	for ( var i in txlst ) {
		html.push('<tr><td>');
		switch(txlst[i].length) {
		case 0:
			html.push(i);
			html.push('</td><td>&nbsp;</td>');
			break;
		case 1:
			html.push('&nbsp;</td><td>');
			html.push(txlst[i][0]);
			html.push('&nbsp;<a href="#" onclick="getProposal(\''+ txlst[i][0] + '\')">Get Data</a>');
			html.push('&nbsp;<a href="#" onclick="revisionProposal(\''+ txlst[i][0] + '\', \''+ i  +'\')">Revision</a>');
			html.push('</td>');
			break;
		case 2:
			html.push('&nbsp;</td><td>');
			html.push(txlst[i][0]);
			html.push('<br>');
			html.push(txlst[i][1]);
			html.push('&nbsp;<a href="#" onclick="checkRevision(\''+ txlst[i][1] + '\')">Revision</a>');
			html.push('</td>');
			break;
		}
		html.push('</td></tr>');
	}
	html.push('</table>');
	$('#state').html(html.join(''));
}

window.onload = function() {
	window.setInterval(function() {
		checkInit();
	}, 500);
}

function checkInit() {
	var redraw = function() {
		for ( var i in txlst ) {
			if (txlst[i].length==0) {
				checkMine(i);
			}
		}
		drawState();
	};
	try {
		rpccall(
			'AlterOrg.GetStatus',
			[],
			function(res){
				if (res.result!=='RUN') {
					$('#log').html('Wait for initializing...');
				} else {
					window.clearInterval(id);
					$('#log').html('')
					id = window.setInterval(redraw, 3000);
				}
			},
			function(req, stat,err) {
				window.clearInterval(id);
				$('#log').html(err.message);
			}
		);
	} catch (e) {
		console.log(e);
	}
}

function checkMine(tx) {
	rpccall(
		'Assembly.CheckMine',
		[tx],
		function(res){
			if (res.result!=='') {
				txlst[tx].push(res.result);
			}
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function checkRevision(tx) {
	rpccall(
		'Assembly.CheckRevisionProposal',
		[tx],
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function save() {
	rpccall(
		'AlterOrg.SaveFile',
		['/Users/emit7c/myports.txt'],
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function savestring() {
	rpccall(
		'AlterOrg.SaveData',
		['テスト文字列'],
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function getfile() {
	rpccall(
		'AlterOrg.GetFile',
		[{
			hash : "QmUyjk8FBViMwqNSYfEHQ8kM6d57mYbtZiZ5mq9Z3vxnBe",
			path : "/Users/emit7c/a"
		}],
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function getdata() {
	rpccall(
		'AlterOrg.GetData',
		["QmUyjk8FBViMwqNSYfEHQ8kM6d57mYbtZiZ5mq9Z3vxnBe"],
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function saveorg() {
	rpccall(
		'AlterOrg.UpdateOrgList',
		"",
		function(res){
			alert(res.result)
		},
		function(req, stat,err) {
			$('#log').html(err.message);
		}
	);
}

function rpccall(method, param, cb, cberr) {
	var data = {
		'jsonrpc':'2.0',
		'id':id++,
		'method':method,
		'params':param
	};
	$.ajax({
		type: "POST",
		url: "http://localhost:1234",
		data: JSON.stringify(data),
		dataType: 'json',
		contentType: "application/json",
		success: cb,
		error : cberr
	});
}
-->
</script>
<body>
<input type="button" id="create" value="作成" onclick="create()">&nbsp;
<input type="button" id="save" value="保存テスト" onclick="save()">&nbsp;
<input type="button" id="savestring" value="文字保存テスト" onclick="savestring()">&nbsp;
<input type="button" id="getfile" value="ファイル取得テスト" onclick="getfile()">&nbsp;
<input type="button" id="getdata" value="データ取得テスト" onclick="getdata()">&nbsp;
<input type="button" id="getdata" value="Org保存テスト" onclick="saveorg()">&nbsp;
<div id="log"></div>
<div id="state" style="width:100%"></div>
</body>
</html>
